<!DOCTYPE html>
<html>
<head>
  <meta charset='UTF-8'>

  <style>
    .zip_polygons {
      fill: none;
      stroke: #777;
      stroke-width: 1;
    }

    .q0 { fill:rgb(247,251,255); }
    .q1 { fill:rgb(222,235,247); }
    .q2 { fill:rgb(198,219,239); }
    .q3 { fill:rgb(158,202,225); }
    .q4 { fill:rgb(107,174,214); }
    .q5 { fill:rgb(66,146,198); }
    .q6 { fill:rgb(33,113,181); }
    .q7 { fill:rgb(8,81,156); }
    .q8 { fill:rgb(8,48,107); }

  </style>
</head>
<body>

<script src="http://d3js.org/d3.v3.min.js?2.9.5"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>

<script>

  // Set width and height for everything!
	var width = 720,
  	height = 720;

  // Add the actual SVG to the body element in the DOM
	var svg = d3.select("body").append("svg")
  	.attr("width", width)
  	.attr("height", height);

  // We will use a mercator projection shifted to center on NYC, and zoomed in
  var projection = d3.geo.mercator()
    .center([-73.94, 40.70])
    .scale(60000)
    .translate([(width) / 2, (height)/2]);

  // This is the path generator -- later, when we make paths they will be 
  // created with the correct projection
  var path = d3.geo.path()
      .projection(projection);

  // Quantize is a method that will take values from 10 to 30 and put them into 
  // one of 9 bins and return the name of the bin
  var quantize = d3.scale.quantize()
      .domain([20, 30])
      .range(d3.range(9).map(function(i) { return "q" + i; }));

  // This map will connect a given zipcode to the mean restaurant score for 
  // that zipcode
  var meanById = d3.map();

  // The queue allows the asynchronous data loading calls to complete before 
  // calling the actual plotting function
  queue()
  	.defer(d3.json, "nyc_zips_topojson.json")
  	.defer(d3.csv, "zip_mean.csv", function(d) { 
      // Create the actual map assign means to zipcodes
      meanById.set(d.ZIPCODE, +d.MEAN); 
    })
  	.await(ready);

  function ready(error, nyc) {

    svg.append("g")
        .attr("class", "zip_polygons")
      .selectAll("path")
        .data(topojson.feature(nyc, nyc.objects.zip_polygons).features)
      .enter().append("path") // add the actual zipcode boundaries
        .attr("class", function(d) { 
          // the data, d, is from the topojson file. The meanById map allows 
          // you to get the mean for a given zipcode, which is the ID in the 
          // topojson file
          return quantize(meanById.get(d.id)); 
        })
        .attr("d", path);

  }

</script>

</body>
</html>
